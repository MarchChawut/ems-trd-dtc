// ============================================
// Prisma Schema สำหรับ EMS (Employee Management System)
// รองรับ MariaDB 10 บน Synology NAS
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// Model: User - ข้อมูลผู้ใช้งานระบบ
// ============================================
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique @db.VarChar(255)
  username  String   @unique @db.VarChar(100)
  password  String   @db.VarChar(255) // เก็บรหัสผ่านที่เข้ารหัสแล้ว
  name      String   @db.VarChar(100)
  role      Role     @default(EMPLOYEE)
  department String? @db.VarChar(100)
  avatar    String?  @db.VarChar(10) // ตัวย่อชื่อสำหรับแสดง avatar
  isActive  Boolean  @default(true)
  
  // ความสัมพันธ์กับตารางอื่น
  tasks     Task[]   // งานที่มอบหมายให้ผู้ใช้
  leaves    Leave[]  // รายการลาของผู้ใช้
  sessions  Session[] // Session สำหรับการเข้าสู่ระบบ
  loginAttempts LoginAttempt[] // ประวัติการพยายามเข้าสู่ระบบ
  
  // timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("users")
}

// ============================================
// Model: Session - เก็บข้อมูล session การเข้าสู่ระบบ
// ใช้สำหรับตรวจสอบและยกเลิก session
// ============================================
model Session {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime
  ipAddress String?  @db.VarChar(45) // IPv6 สูงสุด 45 ตัวอักษร
  userAgent String?  @db.Text
  isValid   Boolean  @default(true)
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@map("sessions")
}

// ============================================
// Model: LoginAttempt - บันทึกการพยายามเข้าสู่ระบบ
// ใช้สำหรับป้องกัน Brute Force Attack
// ============================================
model LoginAttempt {
  id        Int      @id @default(autoincrement())
  userId    Int?
  username  String   @db.VarChar(100)
  ipAddress String   @db.VarChar(45)
  success   Boolean
  reason    String?  @db.VarChar(255) // เหตุผลที่ล้มเหลว
  
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  createdAt DateTime @default(now())
  
  @@index([ipAddress, createdAt])
  @@index([username, createdAt])
  @@map("login_attempts")
}

// ============================================
// Model: Task - งานในระบบ Kanban
// ============================================
model Task {
  id          Int        @id @default(autoincrement())
  title       String     @db.VarChar(255)
  description String?    @db.Text
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  assigneeId  Int?
  
  // ความสัมพันธ์
  assignee   User?      @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  
  @@index([status])
  @@index([assigneeId])
  @@map("tasks")
}

// ============================================
// Model: Leave - รายการลาของพนักงาน
// ============================================
model Leave {
  id          Int         @id @default(autoincrement())
  userId      Int
  type        LeaveType
  startDate   DateTime    @db.Date
  endDate     DateTime    @db.Date
  reason      String      @db.Text
  status      LeaveStatus @default(PENDING)
  approvedBy  Int?        // ID ของผู้อนุมัติ
  approvedAt  DateTime?   
  
  // ความสัมพันธ์
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([startDate, endDate])
  @@map("leaves")
}

// ============================================
// Enums - ประเภทข้อมูลที่ใช้ซ้ำ
// ============================================

// บทบาทของผู้ใช้
enum Role {
  SUPER_ADMIN // ผู้ดูแลระบบสูงสุด
  ADMIN       // ผู้ดูแลระบบ
  MANAGER     // ผู้จัดการ
  EMPLOYEE    // พนักงานทั่วไป
  HR          // ฝ่ายบุคคล
}

// สถานะของงาน
enum TaskStatus {
  TODO        // รอดำเนินการ
  IN_PROGRESS // กำลังทำ
  DONE        // เสร็จสิ้น
}

// ระดับความสำคัญ
enum Priority {
  LOW      // ต่ำ
  MEDIUM   // ปานกลาง
  HIGH     // สูง
  URGENT   // เร่งด่วน
}

// ประเภทการลา
enum LeaveType {
  SICK      // ลาป่วย
  PERSONAL  // ลากิจ
  VACATION  // ลาพักร้อน
  OTHER     // อื่นๆ
}

// สถานะการลา
enum LeaveStatus {
  PENDING   // รอพิจารณา
  APPROVED  // อนุมัติแล้ว
  REJECTED  // ไม่อนุมัติ
}
