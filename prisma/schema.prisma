// ============================================
// Prisma Schema สำหรับ EMS (Employee Management System)
// รองรับ MariaDB 10 บน Synology NAS
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// Model: User - ข้อมูลผู้ใช้งานระบบ
// ============================================
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique @db.VarChar(255)
  username  String   @unique @db.VarChar(100)
  password  String   @db.VarChar(255) // เก็บรหัสผ่านที่เข้ารหัสแล้ว
  prefix    String?  @db.VarChar(50) // คำนำหน้า เช่น นาย, น.ส., ร.ต., ว่าที่ ร.ต., คุณหญิง
  name      String   @db.VarChar(100)
  role      Role     @default(EMPLOYEE)
  department String? @db.VarChar(100) // กอง เช่น กองการศึกษา วิจัย และพัฒนา
  division   String? @db.VarChar(200) // สังกัด เช่น ศูนย์เทคโนโลยีดิจิทัล สำนักพระราชวัง
  position   String? @db.VarChar(100) // ตำแหน่ง เช่น จนท.ฝ่ายธุรการ, ผู้อำนวยการกอง
  positionSecond String? @db.VarChar(100) // ตำแหน่งรอง เช่น ลูกจ้างชั่วคราวรายเดือน, เจ้าหน้าที่งานในพระองค์
  positionLevel Int?    // ระดับ (สำหรับเจ้าหน้าที่งานในพระองค์ 1-11)
  avatar    String?  @db.VarChar(10) // ตัวย่อชื่อสำหรับแสดง avatar
  profileImage String? @db.VarChar(500) // URL รูปโปรไฟล์
  isActive  Boolean  @default(true)
  
  // ความสัมพันธ์กับตารางอื่น
  tasks     Task[]   // งานที่มอบหมายให้ผู้ใช้
  leaves    Leave[]  // รายการลาของผู้ใช้
  sessions  Session[] // Session สำหรับการเข้าสู่ระบบ
  loginAttempts LoginAttempt[] // ประวัติการพยายามเข้าสู่ระบบ
  
  // timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("users")
}

// ============================================
// Model: Session - เก็บข้อมูล session การเข้าสู่ระบบ
// ใช้สำหรับตรวจสอบและยกเลิก session
// ============================================
model Session {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique @db.VarChar(500)
  expiresAt DateTime
  ipAddress String?  @db.VarChar(45) // IPv6 สูงสุด 45 ตัวอักษร
  userAgent String?  @db.Text
  isValid   Boolean  @default(true)
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@map("sessions")
}

// ============================================
// Model: LoginAttempt - บันทึกการพยายามเข้าสู่ระบบ
// ใช้สำหรับป้องกัน Brute Force Attack
// ============================================
model LoginAttempt {
  id        Int      @id @default(autoincrement())
  userId    Int?
  username  String   @db.VarChar(100)
  ipAddress String   @db.VarChar(45)
  success   Boolean
  reason    String?  @db.VarChar(255) // เหตุผลที่ล้มเหลว
  
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  createdAt DateTime @default(now())
  
  @@index([ipAddress, createdAt])
  @@index([username, createdAt])
  @@map("login_attempts")
}

// ============================================
// Model: KanbanColumn - คอลัมน์ในระบบ Kanban
// ============================================
model KanbanColumn {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(50)
  color     String   @default("slate") @db.VarChar(20) // สีของคอลัมน์ (slate, blue, emerald, amber, rose, purple)
  order     Int      @default(0) // ลำดับการแสดงผล
  isDefault Boolean  @default(false) // คอลัมน์เริ่มต้นที่ไม่สามารถลบได้
  
  // ความสัมพันธ์
  tasks     Task[]   // งานในคอลัมน์นี้
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([order])
  @@map("kanban_columns")
}

// ============================================
// Model: Task - งานในระบบ Kanban
// ============================================
model Task {
  id          Int        @id @default(autoincrement())
  title       String     @db.VarChar(255)
  description String?    @db.Text
  columnId    Int        @default(1) // อ้างอิงถึง KanbanColumn
  priority    Priority   @default(MEDIUM)
  assigneeId  Int?
  reminderAt  DateTime?  // วัน/เวลาแจ้งเตือน
  archivedAt  DateTime?  // วัน/เวลาที่เก็บถาวร
  
  // ความสัมพันธ์
  column     KanbanColumn @relation(fields: [columnId], references: [id], onDelete: Restrict)
  assignee   User?        @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  
  @@index([columnId])
  @@index([assigneeId])
  @@map("tasks")
}

// ============================================
// Model: Leave - รายการลาของพนักงาน
// ============================================
model Leave {
  id          Int         @id @default(autoincrement())
  userId      Int
  type        LeaveType
  startDate   DateTime    @db.Date
  endDate     DateTime    @db.Date
  reason      String      @db.Text
  status      LeaveStatus @default(PENDING)
  approvedBy  Int?        // ID ของผู้อนุมัติ
  approvedAt  DateTime?   
  
  // ข้อมูลเพิ่มเติมสำหรับฟอร์ม
  isHalfDay   Boolean     @default(false) // ลาครึ่งวันหรือไม่
  hours       Float?      // จำนวนชั่วโมงที่ลา (ถ้าลาเป็นชั่วโมง)
  totalDays   Float       @default(0) // จำนวนวันลารวม (คำนวณจากกฎ)
  
  // ความสัมพันธ์
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([startDate, endDate])
  @@map("leaves")
}

// ============================================
// Model: LeaveRule - กฎเกณฑ์การลา (Admin กำหนด)
// ============================================
model LeaveRule {
  id              Int      @id @default(autoincrement())
  name            String   @db.VarChar(100)
  startTime       String   @db.VarChar(5) // เวลาเริ่มต้น เช่น "08:30"
  endTime         String   @db.VarChar(5) // เวลาสิ้นสุด เช่น "16:30"
  fullDayHours     Float    @default(8) // จำนวนชั่วโมง = 1 วัน
  halfDayHours     Float    @default(4) // จำนวนชั่วโมง = 0.5 วัน
  maxConsecutiveDays Int   @default(30) // จำนวนวันลาติดต่อกันสูงสุด
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("leave_rules")
}

// ============================================
// Model: Department - แผนก/กอง (Admin จัดการได้)
// ============================================
model Department {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100) // ชื่อแผนก เช่น กองการศึกษา วิจัย และพัฒนา
  description String?  @db.VarChar(255)
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isActive, order])
  @@map("departments")
}

// ============================================
// Model: Position - ตำแหน่งหลัก (Admin จัดการได้)
// ============================================
model Position {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100) // ชื่อตำแหน่ง เช่น จนท.ฝ่ายธุรการ
  description String?  @db.VarChar(255)
  isActive    Boolean  @default(true)
  order       Int      @default(0) // ลำดับการแสดงผล
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isActive, order])
  @@map("positions")
}

// ============================================
// Model: PositionSecond - ตำแหน่งรอง (Admin จัดการได้)
// ============================================
model PositionSecond {
  id          Int      @id @default(autoincrement())
  name        String   @unique @db.VarChar(100) // ชื่อตำแหน่งรอง เช่น เจ้าหน้าที่งานในพระองค์
  description String?  @db.VarChar(255)
  hasLevel    Boolean  @default(false) // มีระดับหรือไม่ (1-11)
  maxLevel    Int?     // ระดับสูงสุด (ถ้ามี)
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isActive, order])
  @@map("position_seconds")
}

// ============================================
// Model: Holiday - วันหยุดของหน่วยงาน (Admin กำหนด)
// ============================================
model Holiday {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Date // วันที่หยุด
  name        String   @db.VarChar(200) // ชื่อวันหยุด เช่น วันสงกรานต์
  description String?  @db.VarChar(500)
  year        Int      // ปี พ.ศ. หรือ ค.ศ.
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([date])
  @@index([year, isActive])
  @@map("holidays")
}

// ============================================
// Enums - ประเภทข้อมูลที่ใช้ซ้ำ
// ============================================

// บทบาทของผู้ใช้
enum Role {
  SUPER_ADMIN // ผู้ดูแลระบบสูงสุด
  ADMIN       // ผู้ดูแลระบบ
  MANAGER     // ผู้จัดการ
  EMPLOYEE    // พนักงานทั่วไป
  HR          // ฝ่ายบุคคล
}

// สถานะของงาน
enum TaskStatus {
  TODO        // รอดำเนินการ
  IN_PROGRESS // กำลังทำ
  DONE        // เสร็จสิ้น
}

// ระดับความสำคัญ
enum Priority {
  LOW      // ต่ำ
  MEDIUM   // ปานกลาง
  HIGH     // สูง
  URGENT   // เร่งด่วน
}

// ประเภทการลา
enum LeaveType {
  SICK        // ลาป่วย
  PERSONAL    // ลากิจ
  VACATION    // ลาพักร้อน
  MATERNITY   // ลาคลอดบุตร
  ORDINATION  // ลาบวช
  OTHER       // อื่นๆ
}

// สถานะการลา
enum LeaveStatus {
  PENDING   // รอพิจารณา
  APPROVED  // อนุมัติแล้ว
  REJECTED  // ไม่อนุมัติ
}
